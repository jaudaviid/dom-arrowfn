<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Ladder - DOM Depth</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel Standalone for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, memo } = React;

        // Color constants and configuration
        const COLORS = { bid: { rgb: '42,161,152' }, ask: { rgb: '220,50,47' } };
        const ANIMATION_DURATION_MS = 300;
        const UPDATE_INTERVAL_MS = { min: 100, max: 250 };
        const MAX_PRICE_LEVELS = 20;
        const BASE_PRICE = 50000;

        /**
         * Mock WebSocket hook emitting DOMSnapshot market depth updates.
         * @param {string} instrument Trading pair (e.g., 'BTC/USD')
         * @param {number} levels Number of price levels to maintain
         * @returns {object} Snapshot with levels, lastPrice, lastSize, timestamp
         */
        const useMockWebSocket = (instrument = 'BTC/USD', levels = MAX_PRICE_LEVELS) => {
            const [snapshot, setSnapshot] = useState({
                instrument,
                levels: [],
                lastPrice: 0,
                lastSize: 0,
                timestamp: Date.now(),
            });

            useEffect(() => {
                // Initialize and set up price levels
                const levelsArray = [];
                for (let i = 0; i < levels; i++) {
                    const offset = (i - Math.floor(levels / 2)) * 0.01;
                    const price = +(BASE_PRICE + offset).toFixed(2);
                    levelsArray.push({
                        price,
                        bidSize: Math.floor(Math.random() * 1000) + 100,
                        askSize: Math.floor(Math.random() * 1000) + 100,
                        bidCount: Math.floor(Math.random() * 10) + 1,
                        askCount: Math.floor(Math.random() * 10) + 1,
                    });
                }

                setSnapshot({
                    instrument,
                    levels: levelsArray,
                    lastPrice: BASE_PRICE,
                    lastSize: 0,
                    timestamp: Date.now(),
                });

                // High-frequency market depth updates
                const interval = setInterval(() => {
                    setSnapshot((prev) => {
                        const newLevels = prev.levels.map((lvl) => ({ ...lvl }));
                        const numUpdates = Math.floor(Math.random() * 3) + 3;

                        // Update random price levels with size and count deltas
                        for (let i = 0; i < numUpdates; i++) {
                            const randomIdx = Math.floor(Math.random() * newLevels.length);
                            const level = newLevels[randomIdx];
                            if (!level) continue;

                            level.bidSize = Math.max(10, level.bidSize + (Math.floor(Math.random() * 200) - 100));
                            level.askSize = Math.max(10, level.askSize + (Math.floor(Math.random() * 200) - 100));

                            if (Math.random() < 0.3) {
                                level.bidCount = Math.max(1, Math.floor(level.bidSize / (Math.random() * 200 + 50)));
                            }
                            if (Math.random() < 0.3) {
                                level.askCount = Math.max(1, Math.floor(level.askSize / (Math.random() * 200 + 50)));
                            }
                        }

                        // Occasional trade event at random level
                        let { lastPrice, lastSize } = prev;
                        if (Math.random() < 0.25) {
                            const tradeLevel = newLevels[Math.floor(Math.random() * newLevels.length)];
                            lastPrice = tradeLevel.price;
                            lastSize = Math.floor(Math.random() * 100) + 1;
                        }

                        return {
                            instrument: prev.instrument,
                            levels: newLevels,
                            lastPrice,
                            lastSize,
                            timestamp: Date.now(),
                        };
                    });
                }, Math.random() * (UPDATE_INTERVAL_MS.max - UPDATE_INTERVAL_MS.min) + UPDATE_INTERVAL_MS.min);

                return () => clearInterval(interval);
            }, [instrument, levels]);

            return snapshot;
        };

        /**
         * Displays bid/ask size with proportional level bar and trade count.
         * Memoized for performance.
         */
        const PriceCell = memo(
            ({ value, count, maxSize = 1, flash, type, onClick }) => {
                const isBid = type === 'bid';
                const typeClass = isBid ? 'solar-bid' : 'solar-ask';
                const flashClass =
                    flash === 'up' ? 'animate-flash-cyan' : flash === 'down' ? 'animate-flash-red' : '';
                const fillRatio = Math.min(1, Math.max(0, value / Math.max(1, maxSize)));
                const barColor = isBid ? COLORS.bid.rgb : COLORS.ask.rgb;

                return (
                    <td
                        className={`px-4 py-3 relative font-mono text-sm font-semibold cursor-pointer transition-all duration-75 cell-border ${flashClass}`}
                        onClick={onClick}
                    >
                        <div
                            className="absolute inset-y-0 left-0"
                            style={{
                                width: `${Math.round(fillRatio * 100)}%`,
                                background: `rgba(${barColor},0.12)`,
                            }}
                        />
                        <div className={`${typeClass} relative z-10 flex items-center justify-between gap-2`}>
                            <span>{value.toLocaleString()}</span>
                            {count !== undefined && <span className="text-xs solar-muted font-mono">{count}</span>}
                        </div>
                    </td>
                );
            },
            (prev, next) =>
                prev.value === next.value &&
                prev.flash === next.flash &&
                prev.count === next.count &&
                prev.maxSize === next.maxSize
        );

        /**
         * Renders a single price level row with bid/ask sizes and flash effects.
         */
        const PriceRow = memo(
            ({ priceLevel, prevLevel, onBidClick, onAskClick, maxSize }) => {
                const [flashState, setFlashState] = useState({ bid: null, ask: null });

                // Detect and flash on size changes
                useEffect(() => {
                    if (!prevLevel) return;

                    const detectChange = (curr, prev) =>
                        curr > prev ? 'up' : curr < prev ? 'down' : null;

                    const nextFlash = {
                        bid: detectChange(priceLevel.bidSize, prevLevel.bidSize),
                        ask: detectChange(priceLevel.askSize, prevLevel.askSize),
                    };

                    if (nextFlash.bid || nextFlash.ask) {
                        setFlashState(nextFlash);
                        const timer = setTimeout(
                            () => setFlashState({ bid: null, ask: null }),
                            ANIMATION_DURATION_MS
                        );
                        return () => clearTimeout(timer);
                    }
                }, [priceLevel, prevLevel]);

                const handleClick = useCallback(
                    (handler) => () => handler(priceLevel.price),
                    [priceLevel.price, onBidClick, onAskClick]
                );

                return (
                    <tr className="row-hover transition-colors duration-75">
                        <PriceCell
                            value={priceLevel.bidSize}
                            count={priceLevel.bidCount}
                            maxSize={maxSize}
                            flash={flashState.bid}
                            type="bid"
                            onClick={handleClick(onBidClick)}
                        />
                        <td className="px-6 py-3 text-center font-mono text-sm font-bold solar-price cell-border">
                            {priceLevel.price.toFixed(2)}
                        </td>
                        <PriceCell
                            value={priceLevel.askSize}
                            count={priceLevel.askCount}
                            maxSize={maxSize}
                            flash={flashState.ask}
                            type="ask"
                            onClick={handleClick(onAskClick)}
                        />
                    </tr>
                );
            },
            (prev, next) =>
                prev.priceLevel.price === next.priceLevel.price &&
                prev.priceLevel.bidSize === next.priceLevel.bidSize &&
                prev.priceLevel.askSize === next.priceLevel.askSize
        );

        /**
         * Main DOM depth market display component.
         */
        const TradingLadder = () => {
            const instrument = 'BTC/USD';
            const snapshot = useMockWebSocket(instrument, MAX_PRICE_LEVELS);
            const [prevSnapshot, setPrevSnapshot] = useState(null);

            // Track previous snapshot for change detection
            useEffect(() => {
                setPrevSnapshot(snapshot);
            }, [snapshot]);

            // Sorted price levels (descending)
            const sortedLevels = useMemo(
                () => (snapshot.levels || []).slice().sort((a, b) => b.price - a.price),
                [snapshot]
            );

            // Maximum size across all levels for proportional bars
            const maxLevelSize = useMemo(() => {
                if (!snapshot.levels?.length) return 1;
                return Math.max(
                    ...snapshot.levels.map((l) => Math.max(l.bidSize || 0, l.askSize || 0)),
                    1
                );
            }, [snapshot]);

            const handleBidClick = useCallback(
                (price) => {
                    const msg = `Buy Limit Order at ${price.toFixed(2)} | ${instrument}`;
                    console.log(`${msg}`);
                    alert(msg);
                },
                [instrument]
            );

            const handleAskClick = useCallback(
                (price) => {
                    const msg = `Sell Limit Order at ${price.toFixed(2)} | ${instrument}`;
                    console.log(`${msg}`);
                    alert(msg);
                },
                [instrument]
            );

            return (
                <div className="min-h-screen p-8 font-sans solar-root">
                                        <style>{`
                        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@300;400;600;800&display=swap');

                        :root {
                            --base03: #fdf6e3; /* background */
                            --base02: #eee8d5;
                            --base0: #657b83; /* primary text */
                            --base1: #586e75;
                            --yellow: #b58900;
                            --orange: #cb4b16;
                            --red: #dc322f;
                            --magenta: #d33682;
                            --violet: #6c71c4;
                            --blue: #268bd2;
                            --cyan: #2aa198;
                            --green: #859900;
                        }

                        * {
                            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                            color: var(--base0);
                        }

                        .font-mono {
                            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
                        }

                        .solar-root {
                            background: linear-gradient(135deg, var(--base03), var(--base02));
                            min-height: 100vh;
                        }

                        .solar-panel {
                            background: rgba(253,246,227,0.8);
                            border: 1px solid rgba(101,123,131,0.06);
                        }

                        .table-header {
                            background: linear-gradient(90deg, rgba(238,232,213,0.95), rgba(245,244,240,0.95));
                            border-bottom: 2px solid rgba(101,123,131,0.06);
                        }

                        .hdr-bid { color: var(--cyan); }
                        .hdr-price { color: var(--yellow); }
                        .hdr-ask { color: var(--red); }

                        .solar-bid { color: var(--cyan); background: rgba(42,161,152,0.06); }
                        .solar-ask { color: var(--red); background: rgba(220,50,47,0.06); }
                        .solar-price { color: var(--orange); background: rgba(245,244,240,0.0); }

                        .solar-accent { color: var(--blue); }
                        .solar-muted { color: var(--base1); }

                        .row-hover:hover { background: rgba(101,123,131,0.03); }

                        .cell-border { border-right: 1px solid rgba(101,123,131,0.04); }

                        @keyframes flash-cyan {
                            0%, 100% { background-color: transparent; }
                            50% { background-color: rgba(42,161,152,0.28); }
                        }

                        @keyframes flash-red {
                            0%, 100% { background-color: transparent; }
                            50% { background-color: rgba(220,50,47,0.28); }
                        }

                        .animate-flash-cyan { animation: flash-cyan 0.3s ease-in-out; }
                        .animate-flash-red { animation: flash-red 0.3s ease-in-out; }

                        .glow-effect { box-shadow: 0 6px 30px rgba(101,123,131,0.06); }

                        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
                        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.6); }
                        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(101,123,131,0.12); border-radius: 4px; }
                        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(101,123,131,0.18); }

                        .bid-indicator { background: var(--cyan); }
                        .ask-indicator { background: var(--red); }
                    `}</style>

                    <div className="max-w-4xl mx-auto">
                        {/* Header */}
                        <div className="mb-8">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-5xl font-black solar-accent tracking-tight mb-2">
                                        DEPTH OF MARKET
                                    </h1>
                                    <div className="flex items-center gap-4">
                                        <div className="w-2 h-2 rounded-full bid-indicator animate-pulse"></div>
                                        <span className="solar-muted text-sm font-semibold">LIVE</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-3xl font-black solar-accent mb-1">
                                        {snapshot.instrument || instrument}
                                    </div>
                                    <div className="text-sm solar-muted font-mono tracking-wider">
                                        Last: <span className="font-bold">{snapshot.lastPrice ? snapshot.lastPrice.toFixed(2) : '-'}</span>
                                        <span className="ml-3">Size: {snapshot.lastSize || '-'}</span>
                                    </div>
                                    <div className="text-xs solar-muted font-mono tracking-wider">
                                        {new Date(snapshot.timestamp || Date.now()).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>

                                <div className="h-1 rounded-full" style={{background: 'linear-gradient(90deg, rgba(181,137,0,0.12), rgba(181,137,0,0.2))'}}></div>
                        </div>

                        {/* Trading Ladder */}
                        <div className="relative glow-effect rounded-xl overflow-hidden solar-panel backdrop-blur-sm">

                            {/* Table Header */}
                            <div className="table-header">
                                <table className="w-full">
                                    <thead>
                                        <tr>
                                            <th className="px-4 py-4 text-left text-xs font-black tracking-widest hdr-bid uppercase">
                                                Bid Size
                                            </th>
                                            <th className="px-6 py-4 text-center text-xs font-black tracking-widest hdr-price uppercase">
                                                Price
                                            </th>
                                            <th className="px-4 py-4 text-right text-xs font-black tracking-widest hdr-ask uppercase">
                                                Ask Size
                                            </th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>

                            {/* Scrollable Price Ladder */}
                            <div className="overflow-y-auto max-h-[600px] custom-scrollbar">
                                <table className="w-full border-collapse">
                                    <tbody>
                                        {sortedLevels.map((level) => {
                                            const prevLevel = prevSnapshot?.levels?.find(
                                                (l) => l.price === level.price
                                            );
                                            return (
                                                <PriceRow
                                                    key={level.price}
                                                    priceLevel={level}
                                                    prevLevel={prevLevel || null}
                                                    maxSize={maxLevelSize}
                                                    onBidClick={handleBidClick}
                                                    onAskClick={handleAskClick}
                                                />
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Legend */}
                        <div className="mt-8 flex items-center gap-8 solar-muted justify-between">
                            <div className="flex items-center gap-2">
                                <div className="w-3 h-3 bid-indicator rounded-sm" />
                                <span className="font-medium">Click BID to BUY</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-3 h-3 ask-indicator rounded-sm" />
                                <span className="font-medium">Click ASK to SELL</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Initialize and render React app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TradingLadder />);
    </script>
</body>

</html>